<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
<title>JSSpec results</title>
<link rel="stylesheet" type="text/css" href="lib/JSSpec.css" />
<script type="text/javascript" src="lib/diff_match_patch.js"></script>
<script type="text/javascript" src="lib/JSSpec.js"></script>
<script type="text/javascript" src="../lib/prototype.js"></script>
<script type="text/javascript" src="../lib/builder.js"></script>
<script type="text/javascript" src="../src/gsa-prototype.js"></script>
<script type="text/javascript" src="fixtures/results.js"></script>
<script type="text/javascript">// <![CDATA[

describe('GSA in general', {
  
  before_each : function() {
    gsa = new Gsa('foo.com');
    //mock out the request method of Json
    Json.Request.addMethods({
      request: function(url) {
        try {
          (this.options.onCreate || Prototype.emptyFunction)(this);
          Json.Responders.dispatch('onCreate', this);
          var head = $$('head')[0];                 
          var script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = 'nonexistant.js';
          script.id = 'json_request';
          head.appendChild(script);
        }
        catch (e) {
          this.dispatchException(e);
        }
      }
    }); 
  },
  
  'should require a domain': function() {
    try {
      var badgsa = new Gsa();
      expect(this).should_fail("no exception raised");
    } catch(e) {
      expect(true).should_be_true();
    }
  },
  
  'should combine the default options and query parameters with the passed ones': function() {
    var newgsa = new Gsa(
      'bar.com',
      {
        proxyreload: true
      }
    );   
    expect(gsa.domain).should_be("foo.com");
    expect(gsa.options.get('proxyreload')).should_not_be(true);
    expect(gsa.options.get('proxystylesheet')).should_be('json');
    expect(newgsa.options.get('proxyreload')).should_be(true);
  },
  
  'should cleanly wrap up the JSON request process': function() {
    expect(Json.activeRequestCount).should_be(0);
    gsa._request();
    expect(Json.activeRequestCount).should_be(1);
    expect($('json_request').id).should_be('json_request');
    Json.callback({foo: 'bar'});
    expect(Json.activeRequestCount).should_be(0);
    expect(gsa._response()).should_be({foo: 'bar'});
  },
  
  'should be able to perform a basic search': function() {
    expect(gsa.search('')).should_be(false);
    expect(gsa.search(null)).should_be(false);
    expect(Json.activeRequestCount).should_be(0);
    expect(gsa.search('jesse newland')).should_be(true);
    expect(Json.activeRequestCount).should_be(1);
    expect($('json_request').id).should_be('json_request');
    Json.callback(results.jnewland);
    expect(gsa.results).should_have(10, "results");
    expect(gsa.results.first.get('url')).should_be('http://kevin.lexblog.com/2007/07/articles/cool-stuff/lexblog-it-director-talks-about-todays-platform-upgrade/');
  }
  
})

// ]]></script>
</head>
<body><div style="display:none;"><p>A</p><p>B</p></div></body>
</html>